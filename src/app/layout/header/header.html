<header class="header">
  <mat-toolbar class="toolbar">
    <div class="toolbar-content container">
      <!-- Hamburger Menu Button (Tools Browser) -->
      <button
        mat-icon-button
        (click)="toggleToolsSidenav()"
        class="hamburger-btn"
        aria-label="Open tools menu"
      >
        <mat-icon>menu</mat-icon>
      </button>

      <!-- Logo / Brand -->
      <a href="https://www.allthethings.dev/" class="logo" aria-label="All The Things home">
        <mat-icon class="logo-icon">construction</mat-icon>
        <span class="logo-text">ALL THE THINGS</span>
      </a>

      <!-- Desktop Navigation -->
      <nav class="desktop-nav hide-mobile">
        <a
          routerLink="/"
          routerLinkActive="active"
          [routerLinkActiveOptions]="{exact: true}"
          class="nav-link"
        >
          Home
        </a>

        <!-- Tools Dropdown -->
        <button
          mat-button
          [matMenuTriggerFor]="toolsMenu"
          #toolsMenuTrigger="matMenuTrigger"
          class="nav-link tools-btn"
        >
          Tools
          <mat-icon>expand_more</mat-icon>
        </button>

        <!-- Blog Link -->
        <a
          routerLink="/blog"
          routerLinkActive="active"
          class="nav-link"
        >
          Blog
        </a>

        <!-- Artist Spotlight Link -->
        <a
          routerLink="/3d-artist-spotlight"
          routerLinkActive="active"
          class="nav-link"
        >
          3D Artist Spotlight
        </a>

        <!-- Resources Link -->
        <a
          routerLink="/resources"
          routerLinkActive="active"
          class="nav-link"
        >
          Resources
        </a>

        <!-- About Dropdown -->
        <button
          mat-button
          [matMenuTriggerFor]="aboutMenu"
          class="nav-link about-btn"
        >
          About
          <mat-icon>expand_more</mat-icon>
        </button>
      </nav>

      <!-- Actions (Desktop) -->
      <div class="actions hide-mobile">
        <!-- Theme Toggle -->
        <button
          mat-icon-button
          (click)="toggleTheme()"
          [matTooltip]="isDarkTheme() ? 'Switch to Light Mode' : 'Switch to Dark Mode'"
          class="theme-toggle"
          aria-label="Toggle theme"
        >
          <mat-icon>{{ isDarkTheme() ? 'light_mode' : 'dark_mode' }}</mat-icon>
        </button>

        <!-- Login Button (when not authenticated) -->
        @if (!(isAuthenticated$ | async)) {
          <button
            mat-button
            (click)="login()"
            class="login-btn"
            aria-label="Login"
          >
            <mat-icon>login</mat-icon>
            <span>Login</span>
          </button>
        }

        <!-- Account Menu (when authenticated) -->
        @if (isAuthenticated$ | async) {
          <button
            mat-icon-button
            [matMenuTriggerFor]="accountMenu"
            class="account-btn"
            aria-label="Account menu"
            [matTooltip]="getUserDisplayName()"
          >
            <mat-icon>account_circle</mat-icon>
          </button>
        }
      </div>

      <!-- Mobile Menu Button -->
      <div class="mobile-actions hide-desktop">
        <!-- Theme Toggle (Mobile) -->
        <button
          mat-icon-button
          (click)="toggleTheme()"
          class="theme-toggle"
          aria-label="Toggle theme"
        >
          <mat-icon>{{ isDarkTheme() ? 'light_mode' : 'dark_mode' }}</mat-icon>
        </button>
      </div>
    </div>
  </mat-toolbar>

  <!-- Tools Dropdown Menu (Desktop) - Mega Menu with Tabs -->
  <mat-menu #toolsMenu="matMenu" class="tools-menu mega-menu" xPosition="after">
    @defer (on idle) {
      <div class="mega-menu-content">
        <mat-tab-group class="mega-menu-tabs" (click)="$event.stopPropagation()">
          <!-- Tab 1: All Tools -->
          <mat-tab label="All Tools">
            <div class="mega-menu-tab-content">
              <div class="mega-menu-columns">
                <!-- Column 1 -->
                <div class="mega-menu-column" *ngIf="shouldShowColumn(0)">
                  @for (tool of getToolsForColumn(0); track tool.id) {
                    <a
                      mat-menu-item
                      [routerLink]="getToolRouterLink(tool.route)"
                      (click)="closeMegaMenu()"
                      class="tool-menu-item"
                    >
                      <mat-icon>{{ tool.icon }}</mat-icon>
                      <span
                        class="tutorial-indicator"
                        [class.has-tutorial]="tool.hasTutorial"
                        [matTooltip]="tool.hasTutorial ? 'Tutorial Available' : 'No Tutorial Yet'"
                        matTooltipPosition="above"
                      ></span>
                      <span>{{ tool.name }}</span>
                    </a>
                  }
                </div>

                <!-- Column 2 -->
                <div class="mega-menu-column" *ngIf="shouldShowColumn(1)">
                  @for (tool of getToolsForColumn(1); track tool.id) {
                    <a
                      mat-menu-item
                      [routerLink]="getToolRouterLink(tool.route)"
                      (click)="closeMegaMenu()"
                      class="tool-menu-item"
                    >
                      <mat-icon>{{ tool.icon }}</mat-icon>
                      <span
                        class="tutorial-indicator"
                        [class.has-tutorial]="tool.hasTutorial"
                        [matTooltip]="tool.hasTutorial ? 'Tutorial Available' : 'No Tutorial Yet'"
                        matTooltipPosition="above"
                      ></span>
                      <span>{{ tool.name }}</span>
                    </a>
                  }
                </div>

                <!-- Column 3 -->
                <div class="mega-menu-column" *ngIf="shouldShowColumn(2)">
                  @for (tool of getToolsForColumn(2); track tool.id) {
                    <a
                      mat-menu-item
                      [routerLink]="getToolRouterLink(tool.route)"
                      (click)="closeMegaMenu()"
                      class="tool-menu-item"
                    >
                      <mat-icon>{{ tool.icon }}</mat-icon>
                      <span
                        class="tutorial-indicator"
                        [class.has-tutorial]="tool.hasTutorial"
                        [matTooltip]="tool.hasTutorial ? 'Tutorial Available' : 'No Tutorial Yet'"
                        matTooltipPosition="above"
                      ></span>
                      <span>{{ tool.name }}</span>
                    </a>
                  }
                </div>
              </div>
            </div>
          </mat-tab>

          <!-- Tab 2: Categories -->
          <mat-tab label="Categories">
            <div class="mega-menu-tab-content">
              <div class="mega-menu-columns">
                <!-- Column 1 -->
                <div class="mega-menu-column" *ngIf="shouldShowCategoryColumn(0)">
                  @for (category of getCategoriesForColumn(0); track category.id) {
                    <a
                      mat-menu-item
                      [routerLink]="['/tools']"
                      [queryParams]="{category: category.id}"
                      (click)="closeMegaMenu()"
                      class="category-menu-item"
                    >
                      <mat-icon>{{ category.icon }}</mat-icon>
                      <div class="category-info">
                        <span class="category-name">{{ category.name }}</span>
                        <span class="category-count">{{ getToolCount(category.id) }} tools</span>
                      </div>
                    </a>
                  }
                </div>

                <!-- Column 2 -->
                <div class="mega-menu-column" *ngIf="shouldShowCategoryColumn(1)">
                  @for (category of getCategoriesForColumn(1); track category.id) {
                    <a
                      mat-menu-item
                      [routerLink]="['/tools']"
                      [queryParams]="{category: category.id}"
                      (click)="closeMegaMenu()"
                      class="category-menu-item"
                    >
                      <mat-icon>{{ category.icon }}</mat-icon>
                      <div class="category-info">
                        <span class="category-name">{{ category.name }}</span>
                        <span class="category-count">{{ getToolCount(category.id) }} tools</span>
                      </div>
                    </a>
                  }
                </div>

                <!-- Column 3 -->
                <div class="mega-menu-column" *ngIf="shouldShowCategoryColumn(2)">
                  @for (category of getCategoriesForColumn(2); track category.id) {
                    <a
                      mat-menu-item
                      [routerLink]="['/tools']"
                      [queryParams]="{category: category.id}"
                      (click)="closeMegaMenu()"
                      class="category-menu-item"
                    >
                      <mat-icon>{{ category.icon }}</mat-icon>
                      <div class="category-info">
                        <span class="category-name">{{ category.name }}</span>
                        <span class="category-count">{{ getToolCount(category.id) }} tools</span>
                      </div>
                    </a>
                  }
                </div>
              </div>
            </div>
          </mat-tab>
        </mat-tab-group>

        <!-- View All Link - Bottom Right -->
        <div class="mega-menu-footer">
          <a
            mat-raised-button
            [routerLink]="['/tools']"
            class="view-all-link"
          >
            <mat-icon>apps</mat-icon>
            <span>View All Tools</span>
          </a>
        </div>
      </div>
    } @placeholder {
      <div class="mega-menu-loading">
        <mat-icon>apps</mat-icon>
        <span>Loading tools menu...</span>
      </div>
    }
  </mat-menu>

  <!-- About Dropdown Menu (Desktop) -->
  <mat-menu #aboutMenu="matMenu" class="about-menu">
    <div class="about-menu-content">
      <!-- About Section Links -->
      <div class="menu-section">
        <a
          mat-menu-item
          routerLink="/about"
          class="about-menu-item"
        >
          <mat-icon>info</mat-icon>
          <span>About All The Tools</span>
        </a>

        <a
          mat-menu-item
          routerLink="/changelog"
          class="about-menu-item"
        >
          <mat-icon>update</mat-icon>
          <span>Changelog</span>
        </a>

        <a
          mat-menu-item
          routerLink="/privacy"
          class="about-menu-item"
        >
          <mat-icon>privacy_tip</mat-icon>
          <span>Privacy Policy</span>
        </a>

        <a
          mat-menu-item
          routerLink="/terms"
          class="about-menu-item"
        >
          <mat-icon>description</mat-icon>
          <span>Terms of Service</span>
        </a>

        <a
          mat-menu-item
          routerLink="/accessibility"
          class="about-menu-item"
        >
          <mat-icon>accessibility</mat-icon>
          <span>Accessibility</span>
        </a>

        <a
          mat-menu-item
          routerLink="/disclaimer"
          class="about-menu-item"
        >
          <mat-icon>warning</mat-icon>
          <span>Disclaimer</span>
        </a>

        <a
          mat-menu-item
          routerLink="/contact"
          class="about-menu-item"
        >
          <mat-icon>contact_mail</mat-icon>
          <span>Contact Us</span>
        </a>
      </div>
    </div>
  </mat-menu>

  <!-- Account Dropdown Menu (Desktop) -->
  <mat-menu #accountMenu="matMenu" class="account-menu">
    <div class="account-menu-content">
      <div class="menu-section">
        <!-- User Info Header -->
        @if (user$ | async; as user) {
          <div class="account-header" mat-menu-item disabled>
            <mat-icon>account_circle</mat-icon>
            <div class="account-info">
              <span class="account-email">{{ user.email }}</span>
              <span class="account-badge ad-free-badge">Ad-Free Active</span>
            </div>
          </div>
        }

        <!-- My Account Link -->
        <a
          mat-menu-item
          routerLink="/account"
          class="account-menu-item"
        >
          <mat-icon>person</mat-icon>
          <span>My Account</span>
        </a>

        <!-- Admin Dashboard Link (only for admins) -->
        @if (isAdmin$ | async) {
          <a
            mat-menu-item
            routerLink="/admin"
            class="account-menu-item"
          >
            <mat-icon>admin_panel_settings</mat-icon>
            <span>Admin Dashboard</span>
          </a>
        }

        <!-- Logout Button -->
        <button
          mat-menu-item
          (click)="logout()"
          class="account-menu-item logout-btn"
        >
          <mat-icon>logout</mat-icon>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </mat-menu>

  <!-- Mobile Sidebar Menu -->
  @if (mobileMenuOpen()) {
    <div class="mobile-menu-overlay" (click)="closeMobileMenu()"></div>
    <div class="mobile-menu" [@slideIn]>
      <nav class="mobile-nav">
        <!-- Home -->
        <a
          routerLink="/"
          routerLinkActive="active"
          [routerLinkActiveOptions]="{exact: true}"
          (click)="closeMobileMenu()"
          class="mobile-nav-link"
        >
          <mat-icon>home</mat-icon>
          <span>Home</span>
        </a>

        <!-- Login/Logout Button (under Home) -->
        @if (!(isAuthenticated$ | async)) {
          <button
            (click)="login(); closeMobileMenu()"
            class="mobile-nav-link login-mobile-btn auth-action-link"
          >
            <mat-icon>login</mat-icon>
            <span>Login</span>
          </button>
        } @else {
          <button
            (click)="logout(); closeMobileMenu()"
            class="mobile-nav-link logout-mobile-btn auth-action-link"
          >
            <mat-icon>logout</mat-icon>
            <span>Logout</span>
          </button>
        }

        <!-- My Account (when authenticated, under Home) -->
        @if (isAuthenticated$ | async) {
          <a
            routerLink="/account"
            routerLinkActive="active"
            (click)="closeMobileMenu()"
            class="mobile-nav-link auth-action-link"
          >
            <mat-icon>person</mat-icon>
            <span>My Account</span>
          </a>
        }

        <!-- Admin Dashboard (when admin, under Home) -->
        @if (isAdmin$ | async) {
          <a
            routerLink="/admin"
            routerLinkActive="active"
            (click)="closeMobileMenu()"
            class="mobile-nav-link auth-action-link admin-link"
          >
            <mat-icon>admin_panel_settings</mat-icon>
            <span>Admin Dashboard</span>
          </a>
        }

        <!-- Divider -->
        <div class="mobile-nav-divider"></div>

        <!-- All Tools -->
        <a
          routerLink="/tools"
          routerLinkActive="active"
          (click)="closeMobileMenu()"
          class="mobile-nav-link"
        >
          <mat-icon>apps</mat-icon>
          <span>All Tools</span>
        </a>

        <!-- 3D Artist Spotlight -->
        <a
          routerLink="/3d-artist-spotlight"
          routerLinkActive="active"
          (click)="closeMobileMenu()"
          class="mobile-nav-link"
        >
          <mat-icon>3d_rotation</mat-icon>
          <span>3D Artist Spotlight</span>
        </a>

        <!-- Resources -->
        <a
          routerLink="/resources"
          routerLinkActive="active"
          (click)="closeMobileMenu()"
          class="mobile-nav-link"
        >
          <mat-icon>link</mat-icon>
          <span>Resources</span>
        </a>

        <!-- Tool Categories -->
        <div class="mobile-categories">
          <p class="mobile-section-title">Categories</p>
          @for (category of categories; track category.id) {
            @if (getToolCount(category.id) > 0) {
              <a
                [routerLink]="['/tools']"
                [queryParams]="{category: category.id}"
                (click)="closeMobileMenu()"
                class="mobile-category-link"
              >
                <mat-icon>{{ category.icon }}</mat-icon>
                <span>{{ category.name }}</span>
                <span class="count">{{ getToolCount(category.id) }}</span>
              </a>
            }
          }
        </div>

        <!-- all the things.dev Section -->
        <div class="mobile-categories">
          <p class="mobile-section-title">
            <mat-icon>language</mat-icon>
            all the things.dev
          </p>

          <a
            routerLink="/blog"
            routerLinkActive="active"
            (click)="closeMobileMenu()"
            class="mobile-category-link"
          >
            <mat-icon>article</mat-icon>
            <span>Blog</span>
          </a>

          <a
            routerLink="/contact"
            routerLinkActive="active"
            (click)="closeMobileMenu()"
            class="mobile-category-link"
          >
            <mat-icon>contact_mail</mat-icon>
            <span>Contact Us</span>
          </a>

          <a
            routerLink="/about"
            routerLinkActive="active"
            (click)="closeMobileMenu()"
            class="mobile-category-link"
          >
            <mat-icon>info</mat-icon>
            <span>About</span>
          </a>

          <a
            routerLink="/changelog"
            routerLinkActive="active"
            (click)="closeMobileMenu()"
            class="mobile-category-link"
          >
            <mat-icon>update</mat-icon>
            <span>Changelog</span>
          </a>

          <a
            routerLink="/privacy"
            routerLinkActive="active"
            (click)="closeMobileMenu()"
            class="mobile-category-link"
          >
            <mat-icon>privacy_tip</mat-icon>
            <span>Privacy Policy</span>
          </a>

          <a
            routerLink="/terms"
            routerLinkActive="active"
            (click)="closeMobileMenu()"
            class="mobile-category-link"
          >
            <mat-icon>description</mat-icon>
            <span>Terms of Service</span>
          </a>

          <a
            routerLink="/accessibility"
            routerLinkActive="active"
            (click)="closeMobileMenu()"
            class="mobile-category-link"
          >
            <mat-icon>accessibility</mat-icon>
            <span>Accessibility</span>
          </a>

          <a
            routerLink="/disclaimer"
            routerLinkActive="active"
            (click)="closeMobileMenu()"
            class="mobile-category-link"
          >
            <mat-icon>gavel</mat-icon>
            <span>Disclaimer</span>
          </a>
        </div>
      </nav>
    </div>
  }
</header>
